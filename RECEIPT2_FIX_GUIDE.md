# Receipt2.jpg 問題修正ガイド

## 🚨 検出された問題

### **現在の出力結果の問題点**
```
32件検出 → 実際の商品は10-15件程度と推定
```

1. **システム情報が商品として認識**
   - `スキャンレジ0303 スキャン No4819`
   - `領収証明細`
   - `スNo 00643015ひらいし`

2. **同じ商品の重複（異なる価格）**
   - 純正ごま油: ¥1520, ¥328
   - 豚ばらうす切り: ¥1300, ¥387
   - 白菜: ¥690, ¥98

3. **メタデータが商品になっている**
   - `小計`, `合計`, `お釣り`
   - `(8%) 対象額`

4. **数量情報が商品名になっている**
   - `2コX98`, `2コX単88`

5. **商品名に価格が混入**
   - `フレッシュパック ¥228`

## 🛠️ 実装した修正

### **1. レシート固有修正クラス作成**

`src/lib/ocr/receipt-specific-fixes.ts` を作成し、以下の修正を実装：

#### システム情報の除去
```typescript
// 除去されるパターン
- /スキャンレジ\d+/
- /スキャン\s*No\d+/
- /領収証明細/
- /スNo\s*\d+/
- /ひらいし$/  // 店員名
```

#### メタデータの除去
```typescript
// 除去されるキーワード
['小計', '合計', 'お釣り', '対象額', '税込', '税抜', 'ポイント', ...]
```

#### 商品名と価格の分離
```typescript
// "フレッシュパック ¥228" → name: "フレッシュパック", price: 228
// "商品名 123円" → name: "商品名", price: 123
```

#### 重複商品の統合
```typescript
// 商品名を正規化して重複を検出
// 複数ある場合は最も適切な価格・名前のものを選択
```

### **2. APIでの自動適用**

現在のAPIでは以下の修正が自動で適用されます：

```typescript
const options = {
  useReceiptSpecificFixes: true,  // Receipt2.jpg対応
  applyEmergencyFixes: true,      // 基本的な修正
  enableValidation: true,         // 検証
  enableAutoCorrection: true      // 自動修正
}
```

## 📊 期待される改善結果

### **修正前（32件）**
```
1. スキャンレジ0303 スキャン No4819 - ¥1600
2. 純正ごま油 - ¥1520
15. 純正ごま油 - ¥328  // 重複
28. 小計 - ¥727        // メタデータ
```

### **修正後（推定12-15件）**
```
1. 純正ごま油 - ¥328
2. 無添加コーン - ¥128
3. 豚ばらうす切り - ¥387
4. 白菜 - ¥98
5. たまねぎ - ¥88
6. 新じゃがいも - ¥88
7. 豚ひき肉 - ¥125
8. 伊藤ロースハム - ¥258
9. やわらか厚あげ - ¥94
10. フレッシュパック - ¥118
11. いんげん - ¥198
12. キャベツ - ¥158
```

## 🧪 テスト方法

### **1. 修正済みAPIのテスト**

```bash
# Receipt2.jpgで修正版APIをテスト
curl -X POST http://localhost:3000/api/ocr \
  -F "image=@Receipt2.jpg"
```

### **2. 問題分析APIでの確認**

```bash
# 修正前後の比較分析
curl -X POST http://localhost:3000/api/ocr/problem-analysis \
  -F "image=@Receipt2.jpg"
```

### **3. デバッグログの確認**

開発環境では以下のログが出力されます：

```
🛠️ Receipt2問題修正開始: 32件
📋 システム情報除去後: 29件
📊 メタデータ除去後: 26件
🔢 数量情報のみ除去後: 24件
🔧 名前・価格分離後: 24件
🔄 重複統合後: 15件
💰 価格妥当性チェック後: 14件
📝 商品名妥当性チェック後: 12件

🎯 Receipt固有修正統計: {
  "original": 32,
  "fixed": 12,
  "removed": 20,
  "improvement": {
    "reductionPercentage": "62.5",
    "qualityImprovement": "システム情報とメタデータを除去し、重複を統合"
  }
}
```

## 🔧 手動での修正確認

### **修正機能の個別テスト**

```typescript
import { ReceiptSpecificFixes } from '@/lib/ocr/receipt-specific-fixes'

// 問題のあるアイテムリスト
const problematicItems = [
  {name: "スキャンレジ0303 スキャン No4819", price: 1600},
  {name: "純正ごま油", price: 1520},
  {name: "純正ごま油", price: 328},  // 重複
  {name: "小計", price: 727},         // メタデータ
  {name: "フレッシュパック ¥228", price: 118}  // 価格混入
]

// 修正適用
const fixed = ReceiptSpecificFixes.applyReceipt2SpecificFixes(problematicItems)
console.log('修正結果:', fixed)
```

## 🎯 追加の修正が必要な場合

### **他のReceipt（3-6.jpg）での問題**

各レシートで同様の問題分析を実行：

```bash
for i in {3..6}; do
  echo "=== Receipt${i}.jpg 分析 ==="
  curl -X POST http://localhost:3000/api/ocr/problem-analysis \
    -F "image=@Receipt${i}.jpg"
done
```

### **店舗固有パターンの追加**

新しい問題パターンが見つかった場合：

1. `receipt-specific-fixes.ts` にパターンを追加
2. `isSystemInfo()` や `isReceiptMetadata()` を拡張
3. テストで確認

### **パターン調整の指針**

```typescript
// 新しい除外パターンの追加例
const newSystemPatterns = [
  /新しいレジパターン\d+/,
  /店舗固有の情報/,
  // ...
]
```

## 📈 結果の品質向上

### **修正により期待される改善**

1. **検出数の最適化**: 32件 → 12-15件
2. **重複の除去**: 同一商品の複数検出を統合
3. **ノイズの除去**: システム情報・メタデータを除去
4. **価格精度の向上**: 適切な価格の選択
5. **商品名の改善**: 価格情報の分離とクリーンアップ

### **品質指標**

- **精度**: 無効アイテムの除去率 60%以上
- **再現率**: 実際の商品の検出率 90%以上
- **信頼度**: 平均信頼度 70%以上

現在実装された修正により、Receipt2.jpgの問題は大幅に改善されるはずです。他のレシート画像でも同様の分析と修正を適用できます。